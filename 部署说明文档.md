# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½² Briefy é¡¹ç›®ã€‚

## ç›®å½•

- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
- [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
- [Docker éƒ¨ç½²](#docker-éƒ¨ç½²)
- [ç›‘æ§ä¸ç»´æŠ¤](#ç›‘æ§ä¸ç»´æŠ¤)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿè¦æ±‚

### æœ€ä½é…ç½®

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 20.04+ / CentOS 8+ / Debian 11+)
- **Python**: 3.12 æˆ–æ›´é«˜ç‰ˆæœ¬
- **å†…å­˜**: 2GB RAMï¼ˆå¯ç”¨ AI æ‘˜è¦åŠŸèƒ½å»ºè®® 4GB+ï¼‰
- **ç£ç›˜**: 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å¯è®¿é—®äº’è”ç½‘ï¼ˆç”¨äºæŠ“å–æ–°é—»æºï¼‰

### æ¨èé…ç½®

- **CPU**: 2 æ ¸+
- **å†…å­˜**: 4GB RAM
- **ç£ç›˜**: 50GB SSDï¼ˆç”¨äºå­˜å‚¨å†å²æ•°æ®ï¼‰

---

## å¿«é€Ÿéƒ¨ç½²

### ä¸€é”®å®‰è£…è„šæœ¬

```bash
#!/bin/bash
set -e

# å®‰è£… uv
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="$HOME/.local/bin:$PATH"

# å…‹éš†é¡¹ç›®
git clone <your-repo-url> /opt/briefy
cd /opt/briefy

# å®‰è£…ä¾èµ–
uv sync --no-dev

# åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆå¦‚æœä½¿ç”¨é»˜è®¤è·¯å¾„ï¼‰
mkdir -p data temp

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /opt/briefy 2>/dev/null || true

echo "âœ… å®‰è£…å®Œæˆï¼è¯·é…ç½® .env æ–‡ä»¶åå¯åŠ¨æœåŠ¡ã€‚"
```

---

## è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡

#### å®‰è£…ç³»ç»Ÿä¾èµ–

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install -y python3 python3-pip python3-venv git nginx
```

**CentOS/RHEL:**
```bash
sudo yum update
sudo yum install -y python3 python3-pip git nginx
```

#### å®‰è£… uv

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
source ~/.bashrc
```

### 2. é¡¹ç›®éƒ¨ç½²

#### å…‹éš†é¡¹ç›®

```bash
sudo mkdir -p /opt
cd /opt
sudo git clone <your-repo-url> briefy
sudo chown -R $USER:$USER /opt/briefy
cd /opt/briefy
```

#### å®‰è£… Python ä¾èµ–

```bash
uv sync --no-dev
```

#### åˆ›å»ºå¿…è¦çš„ç›®å½•

å¦‚æœä½¿ç”¨é»˜è®¤è·¯å¾„ï¼š
```bash
mkdir -p data temp
```

å¦‚æœä½¿ç”¨è‡ªå®šä¹‰è·¯å¾„ï¼ˆåœ¨ .env ä¸­é…ç½®ï¼‰ï¼Œè¯·ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™ï¼š
```bash
sudo mkdir -p /var/lib/briefy/data /var/lib/briefy/temp
sudo chown -R www-data:www-data /var/lib/briefy
```

### 3. é…ç½®æ–‡ä»¶

åˆ›å»º `.env` é…ç½®æ–‡ä»¶ï¼š

```bash
cat > /opt/briefy/.env << 'EOF'
# ====================
# åŸºç¡€é…ç½®
# ====================
# æŠ“å–é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
FETCH_INTERVAL_MINUTES=60

# æ•°æ®å­˜å‚¨è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºé¡¹ç›®ç›®å½•ä¸‹çš„ data æ–‡ä»¶å¤¹ï¼‰
# DATA_DIR=/var/lib/briefy/data

# ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºé¡¹ç›®ç›®å½•ä¸‹çš„ temp æ–‡ä»¶å¤¹ï¼‰
# TEMP_DIR=/var/lib/briefy/temp

# ====================
# AI æ‘˜è¦åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
# ====================
# è®¾ç½®ä¸º 1 å¯ç”¨ AI æ‘˜è¦ç”Ÿæˆ
ENABLE_SUMMARY=0

# Reader API é…ç½®ï¼ˆç”¨äºç½‘é¡µå†…å®¹æå–ï¼‰
READER_API_KEY=your_reader_api_key_here

# LLM é…ç½®
LLM_API_KEY=your_llm_api_key_here
LLM_MODEL=openai/glm-4.5-flash
LLM_API_BASE=https://open.bigmodel.cn/api/paas/v4/

# å…¶ä»– LLM ç¤ºä¾‹ï¼š
# OpenAI: LLM_MODEL=gpt-4o-mini, LLM_API_KEY=sk-xxx, LLM_API_BASE=https://api.openai.com/v1/
# DeepSeek: LLM_MODEL=deepseek/deepseek-chat, LLM_API_KEY=sk-xxx, LLM_API_BASE=https://api.deepseek.com/

# ====================
# è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
# ====================
# è®¾ç½®ä¸º 1 å¯ç”¨ TTS è¯­éŸ³ç”Ÿæˆ
ENABLE_TTS=0
EOF
```

**æ³¨æ„**ï¼š
- å¦‚æœä¸ä½¿ç”¨ AI æ‘˜è¦åŠŸèƒ½ï¼Œä¿æŒ `ENABLE_SUMMARY=0`
- å¦‚æœä¸ä½¿ç”¨è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ï¼Œä¿æŒ `ENABLE_TTS=0`
- å¦‚æœä¿®æ”¹äº† `DATA_DIR` æˆ– `TEMP_DIR`ï¼Œç¡®ä¿å¯¹åº”ç›®å½•å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™
- ç¡®ä¿ `.env` æ–‡ä»¶æƒé™å®‰å…¨ï¼š`chmod 600 .env`

### 4. Systemd æœåŠ¡é…ç½®

åˆ›å»ºç³»ç»ŸæœåŠ¡æ–‡ä»¶ï¼š

```bash
sudo tee /etc/systemd/system/briefy.service > /dev/null << 'EOF'
[Unit]
Description=Briefy - AI News Aggregator
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/briefy
Environment=PATH=/opt/briefy/.venv/bin:/usr/local/bin:/usr/bin
Environment=PYTHONPATH=/opt/briefy
EnvironmentFile=/opt/briefy/.env

# å¯åŠ¨å‘½ä»¤
ExecStart=/opt/briefy/.venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --workers 1

# é‡å¯ç­–ç•¥
Restart=always
RestartSec=10
StartLimitInterval=60s
StartLimitBurst=3

# æ—¥å¿—è¾“å‡º
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

**å¯åŠ¨æœåŠ¡ï¼š**

```bash
# é‡è½½ systemd
sudo systemctl daemon-reload

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable briefy

# å¯åŠ¨æœåŠ¡
sudo systemctl start briefy

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status briefy
```

### 5. Nginx åå‘ä»£ç†

#### å®‰è£… Nginx

```bash
sudo apt install -y nginx  # Ubuntu/Debian
# æˆ–
sudo yum install -y nginx  # CentOS/RHEL
```

#### é…ç½® Nginx

åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```bash
sudo tee /etc/nginx/sites-available/briefy > /dev/null << 'EOF'
upstream briefy {
    server 127.0.0.1:8000;
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS æœåŠ¡
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL è¯ä¹¦ï¼ˆä½¿ç”¨ Let's Encrypt æ—¶ä¼šè‡ªåŠ¨é…ç½®ï¼‰
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # æ—¥å¿—
    access_log /var/log/nginx/briefy-access.log;
    error_log /var/log/nginx/briefy-error.log;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # åå‘ä»£ç†åˆ° FastAPI
    location / {
        proxy_pass http://briefy;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF
```

**å¯ç”¨é…ç½®ï¼š**

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/briefy /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®
sudo rm -f /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

### 6. SSL è¯ä¹¦é…ç½®

#### ä½¿ç”¨ Let's Encryptï¼ˆå…è´¹ï¼‰

```bash
# å®‰è£… Certbot
sudo apt install -y certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# è‡ªåŠ¨ç»­æœŸæµ‹è¯•
sudo certbot renew --dry-run
```

#### æ‰‹åŠ¨é…ç½® SSL

å¦‚æœä½¿ç”¨è‡ªæœ‰è¯ä¹¦ï¼Œä¿®æ”¹ Nginx é…ç½®ä¸­çš„è¯ä¹¦è·¯å¾„ï¼š

```nginx
ssl_certificate /path/to/your/cert.pem;
ssl_certificate_key /path/to/your/key.pem;
```

---

## Docker éƒ¨ç½²

### ä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰

#### 1. åˆ›å»º Dockerfile

```dockerfile
FROM python:3.12-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… uv
RUN pip install uv

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# å®‰è£… Python ä¾èµ–
RUN uv sync --no-dev

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p data temp

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 2. åˆ›å»º docker-compose.yml

```yaml
version: '3.8'

services:
  briefy:
    build: .
    container_name: briefy
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - ./data:/app/data
      - ./temp:/app/temp
      - ./.env:/app/.env:ro
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Asia/Shanghai
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # å¯é€‰ï¼šä½¿ç”¨ Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: briefy-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - briefy
```

#### 3. å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f briefy

# åœæ­¢æœåŠ¡
docker-compose down
```

---

## ç›‘æ§ä¸ç»´æŠ¤

### 1. æ—¥å¿—ç›‘æ§

#### æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# Systemd æ–¹å¼
sudo journalctl -u briefy -f

# Docker æ–¹å¼
docker-compose logs -f briefy
```

#### æŸ¥çœ‹ Nginx æ—¥å¿—

```bash
sudo tail -f /var/log/nginx/briefy-access.log
sudo tail -f /var/log/nginx/briefy-error.log
```

### 2. æ•°æ®å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ `/opt/briefy/backup.sh`ï¼š

```bash
#!/bin/bash

# é…ç½®
BACKUP_DIR="/backup/briefy"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ•°æ®
tar -czf "$BACKUP_DIR/data-$DATE.tar.gz" -C /opt/briefy data/
tar -czf "$BACKUP_DIR/temp-$DATE.tar.gz" -C /opt/briefy temp/

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp /opt/briefy/.env "$BACKUP_DIR/env-$DATE.bak"

# æ¸…ç†æ—§å¤‡ä»½
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "*.bak" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed: $DATE"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š

```bash
chmod +x /opt/briefy/backup.sh

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œï¼‰
(crontab -l 2>/dev/null; echo "0 3 * * * /opt/briefy/backup.sh >> /var/log/briefy-backup.log 2>&1") | crontab -
```

### 3. ç£ç›˜ç©ºé—´ç›‘æ§

```bash
# æ£€æŸ¥æ•°æ®ç›®å½•å¤§å°
du -sh /opt/briefy/data /opt/briefy/temp

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h
```

### 4. è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®

æ·»åŠ å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸæ•°æ®ï¼š

```bash
# æ¸…ç† 30 å¤©å‰çš„ä¸´æ—¶æ•°æ®
0 2 * * * find /opt/briefy/temp -type f -mtime +30 -delete

# æ¸…ç† 90 å¤©å‰çš„æ—§æ•°æ®
0 2 * * 0 find /opt/briefy/data -name "*.md" -mtime +90 -delete
```

---

## æ•…éšœæ’æŸ¥

### 1. æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æ—¥å¿—
sudo journalctl -u briefy -n 100 --no-pager

# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :8000

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
cd /opt/briefy && uv run uvicorn main:app --host 127.0.0.1 --port 8000
```

### 2. æ–°é—»æŠ“å–å¤±è´¥

```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I https://www.cls.cn
curl -I https://wallstreetcn.com

# æ£€æŸ¥ä¸´æ—¶æ•°æ®ç›®å½•æƒé™
ls -la /opt/briefy/temp/

# æ‰‹åŠ¨è¿è¡ŒæŠ“å–æµ‹è¯•
uv run python -c "from fetcher.cailian import fetch; import asyncio; print(asyncio.run(fetch()))"
```

### 3. å†…å­˜å ç”¨è¿‡é«˜

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
free -h
ps aux | grep briefy

# é™åˆ¶æœåŠ¡å†…å­˜ä½¿ç”¨ï¼ˆåœ¨ systemd æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ï¼‰
# MemoryMax=1G
# MemorySwapMax=0
```

### 4. ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æŸ¥æ‰¾å¤§æ–‡ä»¶
find /opt/briefy -type f -size +100M -exec ls -lh {} \;

# æ¸…ç†æ—¥å¿—
sudo journalctl --vacuum-time=7d
```

---

## æ›´æ–°éƒ¨ç½²

### æ›´æ–°ä»£ç 

```bash
cd /opt/briefy

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ›´æ–°ä¾èµ–
uv sync --no-dev

# é‡å¯æœåŠ¡
sudo systemctl restart briefy
```

### æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# å¤‡ä»½å½“å‰æ•°æ®
/opt/briefy/backup.sh

# æ‰§è¡Œè¿ç§»
# uv run python migrate.py

# é‡å¯æœåŠ¡
sudo systemctl restart briefy
```

---

## å®‰å…¨å»ºè®®

1. **é˜²ç«å¢™é…ç½®**
   ```bash
   sudo ufw default deny incoming
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw allow 22/tcp
   sudo ufw enable
   ```

2. **æ–‡ä»¶æƒé™**
   ```bash
   sudo chown -R www-data:www-data /opt/briefy
   sudo chmod 600 /opt/briefy/.env
   sudo chmod 755 /opt/briefy/data /opt/briefy/temp
   ```

3. **å®šæœŸæ›´æ–°**
   ```bash
   # ç³»ç»Ÿæ›´æ–°
   sudo apt update && sudo apt upgrade -y
   
   # Python ä¾èµ–æ›´æ–°
   cd /opt/briefy && uv sync --upgrade
   ```

4. ** fail2ban é˜²æŠ¤**
   ```bash
   sudo apt install fail2ban
   sudo systemctl enable fail2ban
   ```

---

## è”ç³»æ–¹å¼

å¦‚æœ‰éƒ¨ç½²é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹é¡¹ç›® Issues
2. æ£€æŸ¥æœåŠ¡æ—¥å¿—
3. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**éƒ¨ç½²å®Œæˆï¼** ğŸ‰

è®¿é—® `https://your-domain.com` æŸ¥çœ‹æœåŠ¡çŠ¶æ€ã€‚
